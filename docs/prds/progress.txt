# Codebase Patterns — lm-app

## Tech Stack
- Frontend: SvelteKit 2.50 + Svelte 5 runes + Tailwind v4 + shadcn-svelte
- API: Express ES modules (import/export), Node 20+, port 3001
- DB: Supabase PostgreSQL — use supabaseAdmin (service role) for API queries
- Auth: supabase.auth session in frontend, verifyToken middleware in API
- File pattern: src/routes/(auth)/[page]/+page.svelte for frontend pages
- API pattern: api/routes/[feature].js, mounted in api/server.js

## Design Tokens (Vivid Dark)
- Background: #09090b
- Gold accent: #d4a843
- Card bg: #111113, border: rgba(255,255,255,0.06)
- Hover bg: rgba(255,255,255,0.06)
- Headings: Outfit (geometric sans)
- Body: DM Sans
- Vivid accents: indigo #818cf8, blue #60a5fa, violet #a78bfa, emerald #34d399, cyan #22d3ee, amber #fbbf24, orange #fb923c, rose #fb7185
- Use semantic CSS tokens — see src/app.css

## Critical Gotchas
- JS not TS — use JSDoc annotations with @type comments, NO .ts files
- Svelte 5 runes: $state(), $derived(), $props(), $effect() — NO legacy let reactivity
- shadcn-svelte components in src/lib/components/ui/ — NEVER edit directly, add via npx shadcn-svelte add
- Webhook routes mount BEFORE express.json() — Twilio sends URL-encoded
- Pre-push hook runs prettier --check on ENTIRE repo, not just changed files
- PUBLIC_API_URL is baked at BUILD TIME — must override for production builds
- Two Supabase clients: supabase (anon/RLS) and supabaseAdmin (service role)
- From number fallback: from_number || TWILIO_SMS_FROM_NUMBER || TWILIO_TEST1_PHONE_NUMBER || TWILIO_PHONE_NUMBER || TWILIO_MAIN_PHONE_NUMBER
- Use findConversation() and lookupContactByPhone() from api/services/phone-lookup.js — don't duplicate

## Existing Messaging Infrastructure
- Conversations table: phone_number, twilio_number, display_name, contact_id, last_message, last_at, unread_count, status
- Messages table: conversation_id, direction, body, from_number, to_number, twilio_sid, status, media_urls (JSONB), reactions (JSONB), metadata (JSONB), sent_by, created_at
- SMS templates table: name, body, category, tags, is_active, created_by
- Scheduled messages table: to_number, from_number, body, template_id, conversation_id, scheduled_at, status, sent_at, error_message, created_by
- API routes: /api/messages/*, /api/templates/*, /api/scheduled-messages/*
- Webhook: /api/webhooks/sms/incoming, /api/webhooks/sms/status, /api/webhooks/sms/studio-send
- Frontend components: ChatsTab, TemplatesTab, ScheduledTab, ComposeBar, EmojiPicker, TagInsert, TemplateInsert, SchedulePopover, MessageReactions

## Commit Convention
- Format: [area] Brief description
- Co-author line: Co-Authored-By: Claude <noreply@anthropic.com>
- Stage specific files, never git add -A
