# Codebase Patterns — lm-app

## Tech Stack
- Frontend: SvelteKit 2.50 + Svelte 5 runes + Tailwind v4 + shadcn-svelte
- API: Express ES modules (import/export), Node 20+, port 3001
- DB: Supabase PostgreSQL — use supabaseAdmin (service role) for API queries
- Auth: supabase.auth session in frontend, verifyToken middleware in API
- File pattern: src/routes/(auth)/[page]/+page.svelte for frontend pages
- API pattern: api/routes/[feature].js, mounted in api/server.js

## Design Tokens (Vivid Dark)
- Background: #09090b
- Gold accent: #d4a843
- Card bg: #111113, border: rgba(255,255,255,0.06)
- Hover bg: rgba(255,255,255,0.06)
- Headings: Outfit (geometric sans)
- Body: DM Sans
- Use semantic CSS tokens — see src/app.css

## Critical Gotchas
- JS not TS — use JSDoc annotations with @type comments, NO .ts files
- Svelte 5 runes: $state(), $derived(), $props(), $effect() — NO legacy let reactivity
- shadcn-svelte components in src/lib/components/ui/ — NEVER edit directly, add via npx shadcn-svelte add
- Webhook routes mount BEFORE express.json() — Twilio sends URL-encoded
- Pre-push hook runs prettier --check on ENTIRE repo, not just changed files
- PUBLIC_API_URL is baked at BUILD TIME — must override for production builds
- Two Supabase clients: supabase (anon/RLS) and supabaseAdmin (service role)
- From number fallback: from_number || TWILIO_SMS_FROM_NUMBER || TWILIO_TEST1_PHONE_NUMBER || TWILIO_PHONE_NUMBER || TWILIO_MAIN_PHONE_NUMBER
- Use findConversation() and lookupContactByPhone() from api/services/phone-lookup.js — don't duplicate

## Existing Messaging Infrastructure
- Conversations table: phone_number, twilio_number, display_name, contact_id, last_message, last_at, unread_count, status
- Messages table: conversation_id, direction, body, from_number, to_number, twilio_sid, status, media_urls (JSONB), reactions (JSONB), metadata (JSONB), sent_by, created_at
- SMS templates table: name, body, category, tags, is_active, created_by
- Scheduled messages table: to_number, from_number, body, template_id, conversation_id, scheduled_at, status, sent_at, error_message, created_by
- API routes: /api/messages/*, /api/templates/*, /api/scheduled-messages/*
- Webhook: /api/webhooks/sms/incoming, /api/webhooks/sms/status, /api/webhooks/sms/studio-send
- Frontend components: ChatsTab, TemplatesTab, ScheduledTab, ComposeBar, EmojiPicker, TagInsert, TemplateInsert, SchedulePopover, MessageReactions

## Commit Convention
- Format: [area] Brief description
- Co-author line: Co-Authored-By: Claude <noreply@anthropic.com>
- Stage specific files, never git add -A

## SD-004 Learnings
- Svelte 5 $effect() return function is the cleanup — use for clearInterval
- Auto-refresh $effect needs no dependencies to run once on mount
- The ScheduledTab API returns `count` but component reads `res.total` — existing mismatch, didn't fix (out of scope)
- `toLocaleDateString` + `toLocaleTimeString` split gives cleaner formatting than one call with all options

## SD-003 Learnings
- Prettier has no SQL parser — don't include .sql files in prettier --write calls
- The `updated_at` backoff works because scheduled_messages rows are created well before scheduled_at arrives, so updated_at is always old enough on first attempt
- Supabase JS client `.lt('retry_count', 3)` maps to `retry_count < 3` — no raw SQL needed
- When update has conditional fields, use spread: `...(condition && { field: value })`

## SD-002 Learnings
- scheduled_messages.conversation_id may be pre-set (from UI) or null — check it before calling findConversation()
- The find-or-create conversation pattern from POST /api/messages/send is the canonical reference — uses phone_normalized + phone variant matching
- metadata.source='scheduled' + metadata.scheduled_message_id links the message record back to the scheduled_messages row
- Build guard hook blocks `npx vite build` without PUBLIC_API_URL — use `PUBLIC_API_URL=https://api.lemedspa.app npx vite build`
