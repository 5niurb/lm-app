# PRD Templates for the Ralph Loop — Research Findings

**Date:** 2026-02-21
**Purpose:** Identify the best PRD format for autonomous AI agent implementation of voice, messaging,
and CRM features in lm-app.
**Reviewed:** 2026-02-21

---

## Answer

The Ralph Loop (autonomous AI agent that reads a PRD and iterates until all stories are done) has a
canonical format: `prd.json` with user stories containing `id`, `title`, `description`,
`acceptanceCriteria[]`, `priority`, `passes`, and `inProgress` fields. The most practical approach
for lm-app is a **two-file hybrid**: a `prd.md` (human-readable context + tech stack notes) paired
with a `prd.json` (machine-readable task list the agent executes). Your existing `docs/requirements/`
format is already 80% of the way there and should be the source for generating prd.json files.

> **REVIEW NOTE:** Good summary. One key thing to add: the lm-app already has the Anthropic
> ralph-loop plugin installed (skills: `/ralph-loop`, `/cancel-ralph`, `/help`). The research
> correctly identifies that the bash loop (`while :; do cat PROMPT.md | claude-code; done`) is
> superior to the plugin for long runs (context freshness). However, the plugin is fine for
> shorter runs (< 10 iterations). The decision of which to use should be made per-PRD based on
> expected story count.

---

## Key Findings

### 1. Ralph Loop — The Canonical Format

Source: [github.com/snarktank/ralph](https://github.com/snarktank/ralph)

Ralph is the exact pattern described ("Ralph Loop") — a bash script that spawns fresh Claude Code or
Amp instances, each implementing one user story at a time, until all `passes: true`.

**prd.json schema (verified from source):**

```json
{
  "project": "MyApp",
  "branchName": "ralph/feature-name",
  "description": "Brief scope description",
  "userStories": [
    {
      "id": "US-001",
      "title": "Short title under 50 chars",
      "description": "As a [role], I want [action] so that [benefit].",
      "acceptanceCriteria": [
        "Concrete verifiable statement 1",
        "Concrete verifiable statement 2",
        "Typecheck passes",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 1,
      "passes": false,
      "notes": ""
    }
  ]
}
```

> **REVIEW NOTE:** The "Typecheck passes" criterion appears in several places in this doc and
> references `npx tsc --noEmit` below. **lm-app uses JSDoc + checkJs, NOT TypeScript.** There
> is no `tsc` command. The correct build verification is `npx vite build` (which runs Svelte
> compilation + Vite bundling). Replace all "Typecheck passes" criteria with
> `"Build passes: npx vite build"` throughout.

**How the loop works:**

1. Agent reads `prd.json` + `progress.txt` + git history
2. Finds first story where `passes: false`, sorted by `priority` ascending
3. Implements that story
4. Runs quality checks (typecheck, lint, tests)
5. If pass: commits, sets `passes: true`, appends learnings to `progress.txt`
6. If fail: exits iteration without committing (story stays `false`)
7. Loops until all `passes: true` or max iterations reached
8. Outputs `<promise>COMPLETE</promise>` when done

**Key rule:** Each story must fit in one context window. Keep 5-7 acceptance criteria per story.

### 2. Chief — Extended Ralph with `inProgress` field

Source: [minicodemonkey.github.io/chief/concepts/prd-format.html](https://minicodemonkey.github.io/chief/concepts/prd-format.html)

Chief is a TUI built on top of Ralph with one important schema addition: `"inProgress": false`.
When a session is interrupted mid-story, `inProgress: true` lets the next iteration resume rather
than restart. **Recommended addition** for lm-app prd.json files.

Full Chief schema adds:

| Field | Type | Default | Use |
|-------|------|---------|-----|
| `inProgress` | boolean | `false` | Resume interrupted stories |
| `priority` | number | required | Execution order (1 = first) |

Two-file pattern (Chief adds this over pure Ralph):

- `prd.md` — Human context, tech notes, examples, API shapes (Claude reads but never parses)
- `prd.json` — Machine task list (agent executes)

### 3. The `create-prd.md` Skill (snarktank/ai-dev-tasks)

Source: [github.com/snarktank/ai-dev-tasks](https://github.com/snarktank/ai-dev-tasks/blob/main/create-prd.md)

This is a Claude skill that asks 3-5 clarifying questions then generates a `tasks/prd-[feature].md`.
The skill's output template maps directly to prd.json user stories.

PRD sections generated by this skill:

1. Overview (problem + objective)
2. Goals (measurable, specific)
3. User Stories (with acceptance criteria per story)
4. Functional Requirements (numbered FR-xxx statements)
5. Non-Goals (explicit scope boundaries)
6. Design Considerations
7. Technical Considerations
8. Success Metrics
9. Open Questions

**For lm-app:** This skill is the right tool for generating prd.md files before converting to
prd.json. The existing `docs/requirements/` files are the human-readable equivalent already.

> **REVIEW NOTE:** The snarktank create-prd skill generates a LESS detailed output than what
> `docs/requirements/` already contains. Our requirements files include revision history,
> user's original words, exact design specs (hex colors, border values, hover states), and
> API endpoint signatures with query params. Don't downgrade to a generic template — use our
> existing format AS the prd.md and generate prd.json FROM it. The skill is useful only for
> NEW features that don't have requirements docs yet.

### 4. Memory Persistence Pattern (critical for multi-hour runs)

Each fresh agent instance reconstructs context from four sources:

```
progress.txt        — Append-only learnings log; "Codebase Patterns" section at top
prd.json            — Task list with passes status
git history         — Commit log from prior iterations
AGENTS.md files     — Auto-loaded by Claude Code in each directory worked on
```

The `progress.txt` pattern is the most important. The agent appends:

- Discovered patterns (file paths, API shapes, component conventions)
- Gotchas encountered
- What worked vs. what didn't

**For lm-app, the progress.txt should always start with:**

```
# Codebase Patterns
- Tech stack: SvelteKit 2.50 + Svelte 5 runes + Tailwind v4 + shadcn-svelte
- API: Express ES modules, port 3001
- DB: Supabase — use supabaseAdmin (service role) for API calls
- Auth: supabase.auth session in frontend, checked in hooks.server.js
- File pattern: routes/(auth)/[page]/+page.svelte + +page.server.js
- Design: dark bg (#0a0a0c), gold accent (#C5A55A), Playfair Display headings
- Webhook routes mount BEFORE express.json() — Twilio sends URL-encoded
```

> **REVIEW NOTE:** Good section. Should also include these lm-app-specific gotchas that have
> burned us before:
> ```
> - JS not TS — use JSDoc annotations, NO .ts files
> - Svelte 5 runes: $state(), $derived(), $props(), $effect() — NO legacy let reactivity
> - shadcn-svelte components in src/lib/components/ui/ — NEVER edit directly
> - Pre-push hook runs prettier --check on ENTIRE repo, not just changed files
> - PUBLIC_API_URL baked at BUILD TIME — must override for production builds
> - Twilio Studio: make-http-request uses "failed" (past tense) for transitions
> - voicemails.mailbox CHECK constraint must include ALL mailbox values
> ```
> This is the kind of institutional knowledge that prevents wasted iterations. The CLAUDE.md
> already has most of this, but progress.txt should duplicate the critical gotchas so each
> fresh context window gets them without needing to read the full CLAUDE.md.

### 5. Story Sizing Rules

From Ralph, Chief, and the Kovyrin process:

- **Too big:** "Build the contacts page" — agent runs out of context, produces poor code
- **Right size:** "Add tag filter dropdown to contacts list" — one clear UI change
- **Too small:** "Change button color" — wastes iterations on trivial changes

Guideline: If a story has >7 acceptance criteria, split it. If it touches >3 unrelated files, split it.
Target: each story = 1-2 hours of human dev work = one clean agent context window.

### 6. Acceptance Criteria Patterns That Work for Self-Verification

The agent needs to verify its own work. These patterns are verifiable without human input:

**Database/API stories:**

```
- Migration runs without error
- GET /api/contacts returns 200 with correct JSON shape
- POST /api/contacts with invalid phone returns 400 with error message
- Typecheck passes (npx tsc --noEmit)    ← WRONG for lm-app, use: Build passes: npx vite build
```

**Frontend stories:**

```
- Page loads without console errors
- Filter dropdown appears at top of list
- Selecting "patient" tag filters list to only patient-tagged contacts
- Verify in browser using dev-browser skill (visual confirmation)
- Build passes: npx vite build
```

**Integration stories:**

```
- Twilio webhook delivers to /api/webhooks/sms in test environment
- Inbound SMS creates conversation record in Supabase
- CORS check passes: curl -H "Origin: https://lemedspa.app" https://api.lemedspa.app/api/health
```

---

## Recommended PRD Structure for lm-app

### File locations

```
lm-app/
  docs/prds/
    voice-management/
      prd.md          — Human context (tech stack, API shapes, design notes)
      prd.json        — Machine task list (Ralph/Chief executes this)
      progress.txt    — Auto-generated by agent loop
    messaging/
      prd.md
      prd.json
      progress.txt
    contacts-crm/
      prd.md
      prd.json
      progress.txt
```

### prd.md template (human-readable, feeds agent context)

```markdown
# PRD: [Feature Name]

## Overview
What this feature does and why we're building it. One paragraph max.

## Context for Agent
- **Branch name:** ralph/[feature-slug]
- **Tech stack:** SvelteKit + Svelte 5 runes, Express, Supabase, Tailwind v4
- **Key files touched:** [list the main files agent will edit]
- **Design system:** Dark bg #0a0a0c, gold accent #C5A55A, Playfair Display headings
- **API base:** http://localhost:3001 (dev) / https://api.lemedspa.app (prod)

## Technical Context
- Supabase table(s) involved: [list tables + key columns]
- Twilio resources involved: [if any — phone numbers, Studio flows, etc.]
- Related API routes: [GET /api/xxx, POST /api/xxx]
- Related frontend routes: [src/routes/(auth)/xxx/]

## API Shape Reference
[Example request/response JSON for key endpoints]

## Design Reference
[Screenshot filename or URL, or describe the UI pattern]

## Non-Goals
- [Explicit list of what this PRD does NOT cover]

## Open Questions
- [Any ambiguities that need resolution before or during build]
```

### prd.json template (machine-executable)

```json
{
  "project": "lm-app",
  "branchName": "ralph/[feature-slug]",
  "description": "[One sentence scope description]",
  "userStories": [
    {
      "id": "US-001",
      "title": "[Short title — database/API layer first]",
      "description": "As a [role], I want [action] so that [benefit].",
      "acceptanceCriteria": [
        "Supabase migration runs without error",
        "GET /api/xxx returns 200 with { id, field1, field2 } shape",
        "POST /api/xxx with missing required field returns 400",
        "Typecheck passes"
      ],
      "priority": 1,
      "passes": false,
      "inProgress": false,
      "notes": ""
    },
    {
      "id": "US-002",
      "title": "[Frontend — depends on US-001]",
      "description": "As a staff member, I want to see [X] so that [Y].",
      "acceptanceCriteria": [
        "Component renders without console errors",
        "[Specific visible behavior]",
        "[User interaction works as described]",
        "Build passes: npx vite build",
        "Verify in browser using dev-browser skill"
      ],
      "priority": 2,
      "passes": false,
      "inProgress": false,
      "notes": ""
    }
  ]
}
```

---

## Domain-Specific PRD Patterns

> **REVIEW NOTE — CRITICAL:** The story lists below are STALE. They describe the initial build
> from scratch, but **most of these features are already implemented.** Cross-referencing
> `docs/requirements/`:
>
> - **calls.md:** US-001 through US-006 — ALL marked [x] (implemented)
> - **messages.md:** US-001 through US-006 — ALL marked [x] (implemented)
> - **contacts.md:** US-001 through US-004 — ALL marked [x] (implemented)
>
> The Ralph Loop PRDs should target **net-new features** not yet built:
>
> **Voice — What's actually next:**
> - Outbound call logging (currently only inbound from Twilio webhooks)
> - Call analytics / stats dashboard widget
> - Voicemail-to-email notification (Resend)
> - Softphone enhancements (hold, transfer, conference)
>
> **Messaging — What's actually next:**
> - Message templates / quick replies
> - Scheduled messages
> - SMS reactions display (recently built but may need refinement)
> - Bulk messaging / broadcast
> - Message read receipts UI
>
> **Contacts — What's actually next:**
> - Contact detail page (full profile with call/message history timeline)
> - Lead pipeline / Kanban view
> - Contact merge (dedup)
> - Import/export contacts (CSV)
> - Contact notes / activity log
>
> These stories need to be written fresh as prd.json, NOT copied from the generic list below.

### Voice / Call Management Stories (Priority Order) — GENERIC REFERENCE ONLY

1. **DB: calls table schema + API CRUD** — ~~foundation~~ DONE
2. **Twilio webhook: inbound call log** — ~~records call events~~ DONE
3. **Twilio webhook: recording + transcription** — ~~voicemail storage~~ DONE
4. **API: voicemail audio proxy endpoint** — ~~no direct Twilio URL exposure~~ DONE
5. **Frontend: call log list with filters** — ~~direction, search, pagination~~ DONE
6. **Frontend: inline voicemail playback** — ~~audio player in call row~~ DONE
7. **Frontend: softphone page** — DONE (basic), enhancements needed
8. **IVR: Studio flow update** — DONE, ongoing iteration

### Messaging / SMS Stories — GENERIC REFERENCE ONLY

1. **DB: conversations + messages tables** — ~~threading by phone number~~ DONE
2. **Twilio webhook: inbound SMS** — ~~creates/updates conversation~~ DONE
3. **API: conversations list endpoint** — ~~with unread count~~ DONE
4. **API: send SMS endpoint** — ~~Twilio REST call~~ DONE
5. **Frontend: conversation list panel** — ~~left panel, sorted by last message~~ DONE
6. **Frontend: message thread panel** — ~~right panel, bubbles, compose bar~~ DONE
7. **Frontend: new conversation compose** — ~~phone input, start thread~~ DONE
8. **Frontend: real-time polling** — ~~5-second refresh~~ DONE

### Contacts / CRM Stories — GENERIC REFERENCE ONLY

1. **DB: contacts table + tags** — ~~name, phone, email, tags[], source, metadata~~ DONE
2. **API: contacts CRUD** — ~~GET list with search/tag filter, POST create, PATCH update~~ DONE
3. **Auto-creation: from inbound calls** — ~~unknown callers become contacts~~ DONE
4. **Auto-creation: from website form** — ~~webhook creates lead-tagged contact~~ DONE
5. **Frontend: contacts list** — ~~search, tag filter, pagination, quick action icons~~ DONE
6. **Frontend: contact detail view** — NOT YET BUILT — **Ralph Loop candidate**
7. **Frontend: lead pipeline view** — NOT YET BUILT — **Ralph Loop candidate**

---

## Format Recommendation

**Use Ralph's prd.json + Chief's `inProgress` field + your existing docs/requirements format.**

Mapping from your current requirements format to prd.json:

| `docs/requirements/calls.md` | `prd.json` |
|------------------------------|------------|
| `### US-001: [title]` | `"id": "US-001", "title": "[title]"` |
| `**As a** ... **I want** ... **so that** ...` | `"description": "As a..."` |
| `#### Acceptance Criteria` | `"acceptanceCriteria": [...]` |
| `- [ ] AC-1: [text]` | `"[text]"` in array |
| `**Priority:** P0` | `"priority": 1` |
| `**Status:** Planned` | `"passes": false` |

Your `docs/requirements/` files become the **human-readable prd.md**. The prd.json is generated
from them (or written in parallel). This means you're not starting from scratch — you already have
mature requirements for calls, messages, and contacts.

> **REVIEW NOTE:** The mapping table is accurate. One addition: the existing requirements files
> also capture **Design Specifications** (exact hex colors, border values, hover states, spacing)
> and **API Dependencies** (endpoints with query params). These should flow into either:
> - The prd.md "Context for Agent" section (design specs, API shapes), or
> - Individual story `notes` fields in prd.json (when a story needs specific styling)
>
> The priority mapping needs clarification:
> - P0 (critical) → `"priority": 1`
> - P1 (important) → `"priority": 2`
> - P2 (nice to have) → `"priority": 3`
>
> Also: the `[x]` / `[ ]` checkboxes in requirements files should map to `passes`:
> - `[x]` = already implemented = `"passes": true` (or omit from prd.json entirely)
> - `[ ]` = not yet built = `"passes": false`

---

## Resources

- [snarktank/ralph — original Ralph repo](https://github.com/snarktank/ralph)
- [snarktank/ralph prd.json.example](https://github.com/snarktank/ralph/blob/main/prd.json.example)
- [snarktank/ai-dev-tasks — create-prd.md skill](https://github.com/snarktank/ai-dev-tasks/blob/main/create-prd.md)
- [Chief — Autonomous PRD Agent (Ralph TUI)](https://minicodemonkey.github.io/chief/concepts/prd-format.html)
- [Chief Ralph Loop concept](https://minicodemonkey.github.io/chief/concepts/ralph-loop.html)
- [snarktank/ralph DeepWiki](https://deepwiki.com/snarktank/ralph)
- [Agentic PRD concept (prodmoh.com)](https://prodmoh.com/blog/agentic-prd)
- [PRD-driven context engineering (mattgierhart)](https://github.com/mattgierhart/PRD-driven-context-engineering)
- [Kovyrin: Align, Plan, Ship — PRD-to-tasklist process](https://kovyrin.net/2025/06/20/prd-tasklist-process/)
- [How to write PRDs for AI coding agents (haberlah, Medium)](https://medium.com/@haberlah/how-to-write-prds-for-ai-coding-agents-d60d72efb797)
- [vibecoding prd-guide.md](https://github.com/cpjet64/vibecoding/blob/main/prd-guide.md)

---

## Review Summary — 2026-02-21

### Overall Assessment: **Solid research, needs project-specific corrections**

The research agent found all the key Ralph Loop resources and correctly identified the canonical
prd.json format. The two-file hybrid recommendation is right. The resource links are comprehensive
and high-quality.

### Issues Found

| # | Severity | Issue |
|---|----------|-------|
| 1 | **High** | Domain story lists are 100% stale — all three areas (calls, messages, contacts) are already implemented. PRDs need to target net-new features. |
| 2 | **High** | "Typecheck passes (npx tsc --noEmit)" referenced multiple times — lm-app uses JSDoc, not TypeScript. Correct check is `npx vite build`. |
| 3 | **Medium** | prd.md template is LESS detailed than existing `docs/requirements/` format — don't downgrade. Use existing format as-is for the human-readable layer. |
| 4 | **Medium** | No mention that the Anthropic ralph-loop plugin is already installed in this project. Decision needed: plugin vs. bash loop per feature scope. |
| 5 | **Low** | progress.txt codebase patterns section missing critical project-specific gotchas (prettier pre-push, PUBLIC_API_URL build-time, Svelte 5 runes, Twilio Studio quirks). |
| 6 | **Low** | "Verify in browser using dev-browser skill" — no such skill exists in lm-app. Visual verification would need Chrome MCP or Playwright. |

### What's Immediately Actionable

1. **Write prd.json files for net-new features** — contact detail page, lead pipeline, message
   templates, scheduled messages, call analytics. These are the real Ralph Loop candidates.
2. **Create a PROMPT.md** for the bash loop approach (or configure the plugin's prompt) that
   includes the codebase patterns + gotchas block from the review notes above.
3. **Decide: plugin vs. bash loop.** For small feature batches (< 8 stories), the installed
   plugin is fine. For larger batches or overnight runs, use the bash loop for context freshness.
4. **Don't restructure docs/requirements/.** The existing format is superior to the generic
   templates. Just add prd.json files alongside them for Ralph consumption.
